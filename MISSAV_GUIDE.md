# 🔍 MissAV検索機能ガイド

MissAV検索機能の詳細な使用方法とテクニカル情報です。

## 🚀 基本的な使い方

### 1. コマンド形式
```
/missav_search [検索タイトル]
```

### 2. 検索例

#### 女優名で検索
```
/missav_search 乃々瀬あい
/missav_search 椎名ゆな
/missav_search 村上悠華
```

#### 品番で検索
```
/missav_search SSIS-960
/missav_search CAWD-845
/missav_search MIAB-244
```

#### 完全タイトルで検索
```
/missav_search 嫁の連れ子をイラマチオ！ゴミ部屋に引きこもる反抗期の義娘を失禁するまで喉奥ピストン 乃々瀬あい
```

#### キーワード検索
```
/missav_search イラマチオ
/missav_search 義娘
/missav_search 中出し
```

## 📊 検索結果について

### 取得される情報
- **タイトル**: 動画の完全なタイトル
- **視聴URL**: MissAVの動画ページへの直接リンク
- **サムネイル**: 動画のプレビュー画像
- **再生時間**: 動画の長さ（HH:MM:SS形式）
- **関連性スコア**: 検索クエリとの一致度（0.000-1.000）

### 表示件数
- **最大5件**まで表示
- **関連性の高い順**で並び替え
- 複数バージョン（無修正版・通常版）がある場合は両方表示

## 🎯 検索のコツ

### 効果的な検索方法
1. **品番検索**: 最も確実な検索方法
   ```
   /missav_search SSIS-960
   ```

2. **女優名検索**: 特定の女優の作品を探す
   ```
   /missav_search 乃々瀬あい
   ```

3. **キーワード組み合わせ**: より具体的な検索
   ```
   /missav_search 乃々瀬あい イラマチオ
   ```

### 検索が失敗する場合
- タイトルが長すぎる → キーワードに分割
- 古い作品 → 品番で検索
- 英語タイトル → 日本語に変換

## ⚡ 技術仕様

### キャッシュシステム
- **キャッシュ時間**: 30分間
- **キー方式**: 検索タイトルの小文字化
- **メリット**: 同一検索の高速化、サーバー負荷軽減

### レート制限
- **制限時間**: 5分に1回（全コマンド共通）
- **対象**: ユーザー単位
- **回避方法**: 開発環境では`DISABLE_RATE_LIMIT=true`で無効化可能

### セキュリティ
- **NSFWチャンネル必須**: 年齢制限コンテンツのため
- **18歳未満利用禁止**: 利用規約で明記
- **適切な警告表示**: 各検索結果にて注意喚起

## 🔧 開発者向け情報

### 実装詳細
- **スクレイピングエンジン**: Playwright (Chromium)
- **対象サイト**: https://missav123.com
- **検索API**: `/ja/search/{encoded_title}`
- **セレクター**: `div.grid.grid-cols-2 > div`

### 関連性スコア計算
```python
def calculate_relevance(video_title: str, search_title: str) -> float:
    # 完全一致: 1.0
    # 部分一致: 0.8
    # Jaccard係数: intersection/union
```

### エラーハンドリング
- ネットワークエラー → 再試行なし、エラーメッセージ表示
- パースエラー → ログ出力、次の要素に続行
- タイムアウト → 60秒でタイムアウト

## 📝 制限事項

### サイト依存
- MissAVサイトの構造変更に影響を受ける可能性
- サイトのメンテナンス時は利用不可

### 検索精度
- 日本語の表記揺れ（ひらがな・カタカナ・漢字）に影響
- 特殊文字や記号の扱いに制限

### パフォーマンス
- 初回検索時は5-10秒程度の待機時間
- Chromiumブラウザの起動コストあり

## 🐛 トラブルシューティング

### よくある問題

#### 1. 検索結果が出ない
**原因**: タイトルの表記が異なる
**解決法**: 
- 品番で検索
- 女優名のみで検索
- キーワードを分割して検索

#### 2. サムネイルが表示されない
**原因**: 画像URLの取得失敗
**解決法**: 
- 時間をおいて再試行
- 直接動画ページにアクセス

#### 3. 検索が遅い
**原因**: ブラウザ起動・ページ読み込み時間
**解決法**: 
- キャッシュ有効時間内での再検索を活用
- 複数の短いキーワードに分けて検索

### デバッグ方法
```bash
# デバッグスクリプトの実行
python test_missav.py

# 特定タイトルでのテスト
python test_specific_title.py

# HTML構造のデバッグ
python debug_missav.py
```

## 🎬 実際の検索例

### 成功例1: 品番検索
```
入力: /missav_search SSIS-960
結果: 2件の動画（通常版・無修正版）
関連性スコア: 0.800
```

### 成功例2: 女優名検索
```
入力: /missav_search 乃々瀬あい
結果: 5件の動画
関連性スコア: 0.500-0.800
```

### 成功例3: 完全タイトル検索
```
入力: /missav_search 嫁の連れ子をイラマチオ！ゴミ部屋に引きこもる反抗期の義娘を失禁するまで喉奥ピストン 乃々瀬あい
結果: 2件の動画（MIAB-244の異なるバージョン）
関連性スコア: 0.800
```

## 📚 参考リンク

- [MissAV公式サイト](https://missav123.com)
- [Playwright公式ドキュメント](https://playwright.dev/python/)
- [Discord.py公式ドキュメント](https://discordpy.readthedocs.io/)

---

**注意**: この機能は18歳以上の成人向けコンテンツを扱います。適切な年齢制限とNSFWチャンネルでの使用を厳守してください。